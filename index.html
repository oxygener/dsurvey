<!doctype html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- css bootstrap-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!-- css main -->
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <!-- js jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- js bootstrap -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <!-- js cookie -->
    <script src="js/js.cookie.js"></script>
    <!-- js for datepicker -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script type="text/javascript">
    var COOKIE_KEY_LAST_RECORD_URL = 'LAST_RECORD'; //上一次檢驗報告記錄
    var CONFIG_DEFAULT_SELECT = 2;//radio預設選項

    var config; //json格式的config設定檔
    var questions = [];

    $(function() {
        initConfig();
    });

    function goNextPage(pageUrl) {
        console.log('goNextPage');
        //解除綁定
        $(window).unbind('beforeunload');

        //導網址
        window.location.href = pageUrl;
    }


    

    function initConfig() {
        console.log('initConfig()');
        // 讀取config檔案
        $.ajax({
            cache: false,
            url: "config/config.json",
            dataType: "json",
            success: function(data) {
                config = data;
                init();
            }
        });
    }

    function init() {
        console.log('init()');
        initQuestions();
        initInputField();
        initInputSession();

        $('.page').hide();
        $('.page').eq(0).show();



        $(window).bind('beforeunload', function(e) {
            console.log('beforeunload');
            return '資料尚未存檔，確定是否要離開？'; //Chrome v51 (2016/04) 取消自訂wording
        });

        //預設勾選第一個radio button
        $('fieldset').each(function(index, element) {
            $(this).find('input').eq(CONFIG_DEFAULT_SELECT).attr('checked', true);
        });

        //檢查是否有上次檢驗報告紀錄
        var lastRecordUrl = Cookies.get(COOKIE_KEY_LAST_RECORD_URL);
        if (typeof lastRecordUrl != 'undefined') {
            //cookie有值
            $('#btn_lastRecordUrl').show();

            $('#btn_lastRecordUrl').click(function() {
                goNextPage(lastRecordUrl);
                return false; //false : 結束button後續動作
            });
        } else {
            //cookie沒有值
            $('#btn_lastRecordUrl').hide();
        }

        //設定上下頁按鈕
        var currentPage = 0;
        $("#btn_pre").hide();
        $("#btn_pre").click(function() {
            gotoNextAction(--currentPage);
        });

        $("#btn_next").click(function() {
            //必填未填
            if (!checkInputField()) { return false; }

            gotoNextAction(++currentPage);
        });

        //問卷上/下頁 or 結束問卷
        function gotoNextAction(page) {
            if (currentPage != 0) {
                $("#btn_pre").show();
            } else {
                $("#btn_pre").hide();
            }
            //如果是最後一頁，跳到檢驗報告頁
            if (page >= $(".page").length) {
                onClickSubmit();
            } else {
                //顯示上/下一頁
                $(".page").hide();
                $('.page').eq(page).show();
            }
        }

        //點擊問卷送出
        function onClickSubmit() {

            var url = 'report.html?';

            // 取得input field value
            url += $('#ui_if_0_0_value').attr('name') + '=' + $('#ui_if_0_0_value').val() + '&';
            url += $('#ui_if_0_1_value').attr('name') + '=' + $('#ui_if_0_1_value').val() + '&';
            url += $('#ui_if_1_0_value').attr('name') + '=' + $('#ui_if_1_0_value').val() + '&';
            url += $('#ui_if_1_1_value').attr('name') + '=' + $('#ui_if_1_1_value').val() + '&';
            url += $('#ui_if_1_2_value').attr('name') + '=' + $('#ui_if_1_2_value').val() + '&';
            url += $('#ui_if_2_0_value').attr('name') + '=' + $('#ui_if_2_0_value').val() + '&';


            // 取得radio button value
            $('input:checked').each(function(index, element) { //取得Radio button 有check的。
                var qid = $(this).attr('name'); //取得google form id
                var value = $(this).attr('value'); //取得radio button value
                url += qid + '=' + value;

                if (index != $('input:checked').length - 1) { url += '&'; } //最後一個參數不加&
            });



            //將參數記錄至cookie，下次使用
            Cookies.set(COOKIE_KEY_LAST_RECORD_URL, url, { expires: 365 });

            //導網址
            goNextPage(url);

        }
    }

    //將問題從config檔塞到questions[]
    function initQuestions() {
        $.each(config.inputField, function(cIndex, item_inputField) {
            $.each(item_inputField.question, function(sIndex, item_question) {
                questions[item_question.qid] = item_question.title;
            });
        });

        $.each(config.session, function(cIndex, item_session) {
            $.each(item_session.question, function(sIndex, item_question) {
                questions[item_question.qid] = item_question.title;
            });
        });
    }

    //1. 提供method取得物件questions[]
    function getQuestionsVar(name) {
        var result = questions[name];
        return typeof result != 'undefined' ? result : '1';
    }

    function initInputSession() {
        var appendHtml = '';
        //在UI上面產生題目
        $.each(config.session, function(sIndex, item_session) {

            if (sIndex == 1 || sIndex == 3 || sIndex == 4) {
                //當sestion 0,1要在同一個page時，跑到session 1時，不要加<div class=page>屬性
                //do nothing
            } else {
                appendHtml += '<div class=page id=' + ('page' + sIndex) + '>';
            }

            appendHtml += '<p>' + item_session.title + '</p>';

            //todo 需要調整page 考慮修改config格式結構 (等慧倫PSD檔改好)
            $.each(item_session.question, function(qIndex, item_question) {
                appendHtml += '<fieldset>';
                appendHtml += '<legend>' + item_question.title + ' </legend>';
                for (var i = 0; i < 5; i++) {
                    var value = i + 1;
                    appendHtml += '<label>' + (i + 1) + ' </label>';
                    appendHtml += '<input type="radio" name=' + item_question.qid + ' value=' + value + '>';
                }
                appendHtml += '</fieldset>';

            });

            // appendHtml += '</div>';

            if (sIndex == 0 || sIndex == 2 || sIndex == 3) {
                //當sestion 0,1要在同一個page時，跑到session 0時，不要加</div>屬性
                //do nothing
            } else {
                appendHtml += '</div>';
                $('#collect').append(appendHtml);
                appendHtml = '';
            }
        });
    }

    // 設定ui inputField 
    function initInputField() {

        $( ".datepicker" ).datepicker({
            dateFormat : 'yy-mm-dd',
            changeMonth : true,
            changeYear : true,
            yearRange: '-100y:c+nn',
            maxDate: '-1d'
        });

        //聯絡資訊
        $('#ui_if_0_0_value').attr('name', config.inputField[0].question[0].qid);
        $('#ui_if_0_1_value').attr('name', config.inputField[0].question[1].qid);

        //寄到我的信箱
        $('#ui_if_1_0_title').html(config.inputField[1].question[0].title);
        $('#ui_if_1_0_value').attr('name', config.inputField[1].question[0].qid);
        $('#ui_if_1_1_title').html(config.inputField[1].question[1].title);
        $('#ui_if_1_1_value').attr('name', config.inputField[1].question[1].qid);
        $('#ui_if_1_2_title').html(config.inputField[1].question[2].title);
        $('#ui_if_1_2_value').attr('name', config.inputField[1].question[2].qid);
        //服務人員
        $('#ui_if_2_0_title').html(config.inputField[2].question[0].title);
        $('#ui_if_2_0_value').attr('name', config.inputField[2].question[0].qid);
    }

    //檢查是否有必填未填
    function checkInputField() {
        console.log('checkInputField()');
        var isValid = true;

        $('input:visible').not(".optional").each(function() {
            if (!$(this).val()) {
                var qid = $(this).attr('name');
                alert('問題「' + getQuestionsVar(qid) + '」未填');
                isValid = false;
                return false; //跳離each，還是會繼續走method的程式
            }
        });

        return isValid;
    }
    </script>
</head>

<body>
    <!-- 第1頁 -->
    <div class="page container">
        <img class="img-fluid" alt="Responsive image" src="image/index/p1/p1_banner.png">
        
        <div class="text-center pt-5 pb-5">
            <a id="downloadReport" href="#btn_next"><img src="image/index/p1/p1_start.png" class="img-fluid p-2" alt="Responsive image"></a>
            <a id="btn_lastRecordUrl" href="index.html"><img src="image/index/p1/p1_report.png" class="img-fluid p-2" alt="Responsive image">
            </a>
        </div>
        <div class="text-center">
            <a href="https://youtu.be/Pa8yMexQqtU" target="_blank"><img src="image/index/p1/p1_video.png" class="img-fluid p-2" alt="Responsive image"></a>
        </div>
        
        <img class="img-fluid" alt="Responsive image" src="image/index/flow.jpg">

        <img class="img-fluid" alt="Responsive image" src="image/index/p1/p1_progress.png">

        <!-- Bootstrap Contact Form -->
        <div class="container contact-form">
            <form method="post">
                <div class="p-3 text-center">
                        <h3>個人基本資料（必填）</h3>
                        <p class="pt-3">請填寫您的真實姓名與出生年月日，作為您的個人化改善方案報告依據。</p>
                    </div>    
                <div class="row">
                    

                    <div class="col-md-12">
                        <div class="form-group">
                            <input id="ui_if_0_0_value" type="text" name="txtName" class="form-control" placeholder="姓名：" value="" />
                        </div>
                        <div class="form-group">
                            <input type="text" id="ui_if_0_1_value" class="form-control datepicker" placeholder="生日：">  
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id='collect'>
    </div>
    <div class="page container">
        <div>
            <label id="ui_if_1_0_title" for="ui_if_1_0_value">name</label>
            <input id="ui_if_1_0_value" type="text" class="form-control optional">
        </div>
        <div>
            <label id="ui_if_1_1_title" for="ui_if_1_1_value">name</label>
            <input id="ui_if_1_1_value" type="text" class="form-control optional">
        </div>
        <div>
            <label id="ui_if_1_2_title" for="ui_if_1_2_value">name</label>
            <input id="ui_if_1_2_value" type="text" class="form-control optional">
        </div>
        <div>
            <label id="ui_if_2_0_title" for="ui_if_2_0_value">name</label>
            <input id="ui_if_2_0_value" type="text" class="form-control optional">
        </div>
    </div>
    <script type="text/javascript">
    </script>
    <div class="text-center">
    <!-- <button id="btn_pre">上一頁</button> -->

    <div class="text-center">
        <img id="btn_next" src="image/index/p1/p1_next.jpg" class="img-fluid p-2" alt="Responsive image">
    </div>
    </div>
    
    <br>
    
</body>

</html>